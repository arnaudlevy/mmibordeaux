<h2>Mon service <%= @year %></h2>
<% if current_user.tenured %>
  Je suis permanent dans l'équipe pédagogique<% if current_user.hours %>, et mon service est de <%= current_user.hours %>h<% end %>.
<% else %>
  Je suis vacataire.
<% end %>
<div class="row">
  <div class="col-md-2">
    <div class="text-xl"><%= @year.scheduled_teacher_hours_for(current_user).round %><small>H</small></div>
  </div>
  <div class="col-md-2">
    <div class="text-xl"><%= @year.scheduled_teacher_hours_for(current_user, :cm).round %><small>CM</small></div>
  </div>
  <div class="col-md-3">
    <div class="text-xl"><%= @year.scheduled_teacher_hours_for(current_user, :td).round %><small>TD</small></div>
    <p><%= @year.scheduled_student_hours_for(current_user, :td).round %> heures TD avec chaque étudiant</p>
  </div>
  <div class="col-md-3">
    <div class="text-xl"><%= @year.scheduled_teacher_hours_for(current_user, :tp).round %><small>TP</small></div>
    <p><%= @year.scheduled_student_hours_for(current_user, :tp).round %> heures TP avec chaque étudiant</p>
  </div>
  <% if current_user.tenured && current_user.hours%>
    <% delta = @year.scheduled_delta_for(current_user) %>
    <div class="col-md-2">
      <div class="btn btn-block <%= delta >= 0 ? 'btn-success' : ' btn-danger' %>">
        <div class="text-xl"><%= delta.round %>h</div>
        <strong><% if delta >= 0 %>Heures complémentaires<% else %>Sous-service<% end %></strong>
      </div>
    </div>
  <% end %>
</div>

<hr class="spacer">

<h2>Projets dont je suis responsable</h2>

<table class="table">
  <thead>
    <tr>
      <th>Semestre</th>
      <th>Projet</th>
      <th>Dates</th>
      <th>Volume d'heures étudiant</th>
      <th>Heures sans intervenant (heures étudiant, dans l'EDT)</th>
    </tr>
  </thead>
  <tbody>
    <% @projects_in_charge.each do |project| %>
      <tr>
        <td><%= project.semesters.join(', ') %></td>
        <td><%= project %></td>
        <td>
          Du <%= l project.from, format: "%d/%m" %>
          au <%= l project.to, format: "%d/%m/%Y" %>
        </td>
        <td>
          <%= project.student_hours %>
          (<%= project.student_hours_cm %>/<%= project.student_hours_td %>/<%= project.student_hours_tp %>)
        </td>
        <% hours_with_no_one = project.events_for_user(User.temporary).sum(:student_hours) %>
        <td class="<%= 'bg-danger' if hours_with_no_one > 0 %>"><%= hours_with_no_one.round %></td>
      </tr>
    <% end %> 
  </tbody>
</table>

<hr class="spacer">

<h2>Projets dans lesquels j'interviens</h2>
<% @projects.each do |project| %>
  <div class="panel panel-default">
    <div class="panel-heading">
      <div class="pull-right">
        <% project.semesters.each do |semester| %>
          <span class="label label-primary"><%= semester %></span>
        <% end %>
      </div>
      <h3><%= link_to project, [project.year, project] %></h3>
      <h5>Responsable du projet: <%= project.user %></h5>
    </div>
    <div class="panel-body">
      <% project.involvements.where(user: current_user).each do |involvement| %>
        <div class="row">
          <div class="col-md-2">
            <%= simple_format involvement.description %>
          </div>
          <div class="col-md-2<% if involvement.student_hours.zero? %> text-muted <% end %>">
            <div class="text-xl"><%= involvement.student_hours.round %><small>h</small></div>
             <strong>avec chaque étudiant</strong><br/>
             <%= involvement.teacher_hours.round %>h d'enseignement en tout.
          </div>
          <div class="col-md-2<% if involvement.student_hours_cm.zero? %> text-muted <% end %>">
            <div class="text-xl"><%= involvement.student_hours_cm.round %><small>CM</small></div>
            <strong>cours magistral</strong><br/>
            En classe entière, à assurer une seule fois.
          </div>
          <div class="col-md-2<% if involvement.student_hours_td.zero? %> text-muted <% end %>">
            <div class="text-xl"><%= involvement.student_hours_td.round %><small>TD</small></div>
            <strong>travaux dirigés</strong><br/>
            <% if involvement.student_hours_td > 0 %>
              En demi-groupe, à assurer <%= involvement.multiplier_td %> fois. 
              Cela fait donc un total de <%= involvement.teacher_hours_td.round %>h d'enseignement en TD.
            <% end %>
          </div>
          <div class="col-md-2<% if involvement.student_hours_tp.zero? %> text-muted <% end %>">
            <div class="text-xl"><%= involvement.student_hours_tp.round %><small>TP</small></div>
            <strong>travaux pratiques</strong><br/>
            <% if involvement.student_hours_tp > 0 %>
              Avec <%= involvement.multiplier_tp %> groupes, à assurer <%= involvement.groups_tp %> fois. 
              Cela fait donc un total de <%= involvement.teacher_hours_tp.round %>h d'enseignement en TP.
            <% end %>
          </div>
          <div class="col-md-2">
            <h4><%= involvement.teaching_module %> (<%= involvement.teaching_module.semester %>)</h4>
            <p><%= involvement.teaching_module.label %></p>
          </div>
        </div>
        <hr>
      <% end %>
    </div>
  </div>
<% end %>

<hr class="spacer">

<h2>Modules</h2>
<div class="table-responsive">
  <table class="table">
    <thead>
      <tr>
        <th>Code</th>
        <th>Module</th>
        <th>Semestre</th>
        <th>Total heures enseignant</th>
        <th>CM</th>
        <th>TD</th>
        <th>TP</th>
      </tr>
    </thead>
    <tbody>
      <% @teaching_modules.each do |teaching_module| %>
        <tr>
          <td><%= teaching_module.code %></td>
          <td><%= teaching_module.label %></td>
          <td><%= teaching_module.semester %></td>
          <td><%= @year.planned_hours_for_teaching_module_and_user(teaching_module, current_user).round %></td>
          <td><%= @year.planned_hours_for_teaching_module_and_user(teaching_module, current_user, :teacher_hours_cm).round %></td>
          <td><%= @year.planned_hours_for_teaching_module_and_user(teaching_module, current_user, :teacher_hours_td).round %></td>
          <td><%= @year.planned_hours_for_teaching_module_and_user(teaching_module, current_user, :teacher_hours_tp).round %></td>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
